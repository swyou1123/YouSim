{"version":3,"file":"withSentryServerSideAppGetInitialProps.js","sources":["../../../../src/config/wrappers/withSentryServerSideAppGetInitialProps.ts"],"sourcesContent":["import { hasTracingEnabled } from '@sentry/tracing';\nimport { serializeBaggage } from '@sentry/utils';\nimport App from 'next/app';\n\nimport { isBuild } from '../../utils/isBuild';\nimport { callTracedServerSideDataFetcher, getTransactionFromRequest, withErrorInstrumentation } from './wrapperUtils';\n\ntype AppGetInitialProps = typeof App['getInitialProps'];\n\n/**\n * Create a wrapped version of the user's exported `getInitialProps` function in\n * a custom app (\"_app.js\").\n *\n * @param origAppGetInitialProps The user's `getInitialProps` function\n * @param parameterizedRoute The page's parameterized route\n * @returns A wrapped version of the function\n */\nexport function withSentryServerSideAppGetInitialProps(origAppGetInitialProps: AppGetInitialProps): AppGetInitialProps {\n  return async function (\n    ...appGetInitialPropsArguments: Parameters<AppGetInitialProps>\n  ): ReturnType<AppGetInitialProps> {\n    if (isBuild()) {\n      return origAppGetInitialProps(...appGetInitialPropsArguments);\n    }\n\n    const [context] = appGetInitialPropsArguments;\n    const { req, res } = context.ctx;\n\n    const errorWrappedAppGetInitialProps = withErrorInstrumentation(origAppGetInitialProps);\n\n    if (hasTracingEnabled()) {\n      // Since this wrapper is only applied to `getInitialProps` running on the server, we can assert that `req` and\n      // `res` are always defined: https://nextjs.org/docs/api-reference/data-fetching/get-initial-props#context-object\n      const appGetInitialProps: {\n        pageProps: {\n          _sentryTraceData?: string;\n          _sentryBaggage?: string;\n        };\n      } = await callTracedServerSideDataFetcher(\n        errorWrappedAppGetInitialProps,\n        appGetInitialPropsArguments,\n        req!,\n        res!,\n        {\n          dataFetcherRouteName: '/_app',\n          requestedRouteName: context.ctx.pathname,\n          dataFetchingMethodName: 'getInitialProps',\n        },\n      );\n\n      const requestTransaction = getTransactionFromRequest(req!);\n      if (requestTransaction) {\n        appGetInitialProps.pageProps._sentryTraceData = requestTransaction.toTraceparent();\n        appGetInitialProps.pageProps._sentryBaggage = serializeBaggage(requestTransaction.getBaggage());\n      }\n\n      return appGetInitialProps;\n    } else {\n      return errorWrappedAppGetInitialProps(...appGetInitialPropsArguments);\n    }\n  };\n}\n"],"names":[],"mappings":";;;;;AASA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;"}